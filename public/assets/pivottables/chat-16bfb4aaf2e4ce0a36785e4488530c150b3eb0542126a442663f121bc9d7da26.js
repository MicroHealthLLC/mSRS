function trace(e){if("\n"===e[e.length-1]&&(e=e.substring(0,e.length-1)),window.performance){var t=(window.performance.now()/1e3).toFixed(3);console.log(t+": "+e)}else console.log(e)}function requestUserMedia(r){return new Promise(function(t,i){var e=function(e){t(e)},n=function(e){i(e)};try{getUserMedia(r,e,n)}catch(o){i(o)}})}function mergeConstraints(e,t){if(!e||!t)return e||t;var i=e;for(var n in t.mandatory)i.mandatory[n]=t.mandatory[n];return i.optional=i.optional.concat(t.optional),i}function iceCandidateType(e){return e.split(" ")[7]}function maybeSetOpusOptions(e,t){return"true"===t.opusStereo?e=setCodecParam(e,"opus/48000","stereo","1"):"false"===t.opusStereo&&(e=removeCodecParam(e,"opus/48000","stereo")),"true"===t.opusFec?e=setCodecParam(e,"opus/48000","useinbandfec","1"):"false"===t.opusFec&&(e=removeCodecParam(e,"opus/48000","useinbandfec")),t.opusMaxPbr&&(e=setCodecParam(e,"opus/48000","maxplaybackrate",t.opusMaxPbr)),e}function maybeSetAudioSendBitRate(e,t){return t.audioSendBitrate?(trace("Prefer audio send bitrate: "+t.audioSendBitrate),preferBitRate(e,t.audioSendBitrate,"audio")):e}function maybeSetAudioReceiveBitRate(e,t){return t.audioRecvBitrate?(trace("Prefer audio receive bitrate: "+t.audioRecvBitrate),preferBitRate(e,t.audioRecvBitrate,"audio")):e}function maybeSetVideoSendBitRate(e,t){return t.videoSendBitrate?(trace("Prefer video send bitrate: "+t.videoSendBitrate),preferBitRate(e,t.videoSendBitrate,"video")):e}function maybeSetVideoReceiveBitRate(e,t){return t.videoRecvBitrate?(trace("Prefer video receive bitrate: "+t.videoRecvBitrate),preferBitRate(e,t.videoRecvBitrate,"video")):e}function preferBitRate(e,t,i){var n=e.split("\r\n"),o=findLine(n,"m=",i);if(null===o)return trace("Failed to add bandwidth line to sdp, as no m-line found"),e;var r=findLineInRange(n,o+1,-1,"m=");null===r&&(r=n.length);var s=findLineInRange(n,o+1,r,"c=");if(null===s)return trace("Failed to add bandwidth line to sdp, as no c-line found"),e;var a=findLineInRange(n,s+1,r,"b=AS");a&&n.splice(a,1);var c="b=AS:"+t;return n.splice(s+1,0,c),e=n.join("\r\n")}function maybeSetVideoSendInitialBitRate(e,t){var i=t.videoSendInitialBitrate;if(!i)return e;var n=i,o=t.videoSendBitrate;return o&&(o<i&&(trace("Clamping initial bitrate to max bitrate of "+o+" kbps."),i=o,t.videoSendInitialBitrate=i),n=o),null===findLine(e.split("\r\n"),"m=","video")?(trace("Failed to find video m-line"),e):e=setCodecParam(e=setCodecParam(e,"VP8/90000","x-google-min-bitrate",t.videoSendInitialBitrate.toString()),"VP8/90000","x-google-max-bitrate",n.toString())}function maybePreferAudioSendCodec(e,t){return maybePreferCodec(e,"audio","send",t.audioSendCodec)}function maybePreferAudioReceiveCodec(e,t){return maybePreferCodec(e,"audio","receive",t.audioRecvCodec)}function maybePreferVideoSendCodec(e,t){return maybePreferCodec(e,"video","send",t.videoSendCodec)}function maybePreferVideoReceiveCodec(e,t){return maybePreferCodec(e,"video","receive",t.videoRecvCodec)}function maybePreferCodec(e,t,i,n){var o=t+" "+i+" codec";if(""===n)return trace("No preference on "+o+"."),e;trace("Prefer "+o+": "+n);var r=e.split("\r\n"),s=findLine(r,"m=",t);if(null===s)return e;var a=getCodecPayloadType(r,n);return a&&(r[s]=setDefaultCodec(r[s],a)),e=r.join("\r\n")}function setCodecParam(e,t,i,n){var o=e.split("\r\n"),r=findFmtpLine(o,t),s={};if(null===r){var a=findLine(o,"a=rtpmap",t);if(null===a)return e;var c=getCodecPayloadTypeFromLine(o[a]);s.pt=c.toString(),s.params={},s.params[i]=n,o.splice(a+1,0,writeFmtpLine(s))}else(s=parseFmtpLine(o[r])).params[i]=n,o[r]=writeFmtpLine(s);return e=o.join("\r\n")}function removeCodecParam(e,t,i){var n=e.split("\r\n"),o=findFmtpLine(n,t);if(null===o)return e;var r=parseFmtpLine(n[o]);delete r.params[i];var s=writeFmtpLine(r);return null===s?n.splice(o,1):n[o]=s,e=n.join("\r\n")}function parseFmtpLine(e){var t={},i=e.indexOf(" "),n=e.substring(i+1).split("; "),o=new RegExp("a=fmtp:(\\d+)"),r=e.match(o);if(!r||2!==r.length)return null;t.pt=r[1];for(var s={},a=0;a<n.length;++a){var c=n[a].split("=");2===c.length&&(s[c[0]]=c[1])}return t.params=s,t}function writeFmtpLine(e){if(!e.hasOwnProperty("pt")||!e.hasOwnProperty("params"))return null;var t=e.pt,i=e.params,n=[],o=0;for(var r in i)n[o]=r+"="+i[r],++o;return 0===o?null:"a=fmtp:"+t.toString()+" "+n.join("; ")}function findFmtpLine(e,t){var i=getCodecPayloadType(e,t);return i?findLine(e,"a=fmtp:"+i.toString()):null}function findLine(e,t,i){return findLineInRange(e,0,-1,t,i)}function findLineInRange(e,t,i,n,o){for(var r=-1!==i?i:e.length,s=t;s<r;++s)if(0===e[s].indexOf(n)&&(!o||-1!==e[s].toLowerCase().indexOf(o.toLowerCase())))return s;return null}function getCodecPayloadType(e,t){var i=findLine(e,"a=rtpmap",t);return i?getCodecPayloadTypeFromLine(e[i]):null}function getCodecPayloadTypeFromLine(e){var t=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),i=e.match(t);return i&&2===i.length?i[1]:null}function setDefaultCodec(e,t){var i=e.split(" "),n=i.slice(0,3);n.push(t);for(var o=3;o<i.length;o++)i[o]!==t&&n.push(i[o]);return n.join(" ")}function extractStatAsInt(e,t,i){var n=extractStat(e,t,i);if(n){var o=parseInt(n);if(-1!==o)return o}return null}function extractStat(e,t,i){var n=getStatsReport(e,t,i);return n&&-1!==n.names().indexOf(i)?n.stat(i):null}function getStatsReport(e,t,i,n){if(e)for(var o=0;o<e.length;++o){var r=e[o];if(r.type===t){var s=!0;if(i){var a=r.stat(i);s=n!==undefined?a===n:a}if(s)return r}}}function computeRate(e,t,i){var n=e.stat(i),o=t?t.stat(i):null;return null===n||null===o?null:(n-o)/(e.timestamp-t.timestamp)*1e3}function computeBitrate(e,t,i){return 8*computeRate(e,t,i)}function computeE2EDelay(e,t){return e?Date.now()+22089888e5-e-1e3*t:null}function $(e){return document.querySelector(e)}function queryStringToDictionary(e){var t=e.slice(1).split("&"),i={};return t.forEach(function(e){e&&(e=e.split("="))[0]&&(i[e[0]]=decodeURIComponent(e[1]||""))}),i}function sendAsyncUrlRequest(n,o,r){return new Promise(function(e,t){var i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&(200===i.status?e(i.responseText):t(Error("Status="+i.status+", response="+i.responseText)))},i.open(n,o,!0),i.send(r)})}function requestTurnServers(e,r){return new Promise(function(n,o){sendAsyncUrlRequest("GET",e).then(function(e){var t=parseJSON(e);if(t){0<r.length&&filterTurnUrls(t.uris,r);var i=createIceServers(t.uris,t.username,t.password);i?(trace("Retrieved TURN server information."),n(i)):o(Error("Error creating ICE servers from response."))}else o(Error("Error parsing response JSON: "+e))})["catch"](function(e){o(Error("TURN server request error: "+e.message))})})}function parseJSON(e){try{return JSON.parse(e)}catch(t){trace("Error parsing json: "+e)}return null}function filterTurnUrls(e,t){for(var i=0;i<e.length;){var n=e[i].split("?");1<n.length&&n[1]!=="transport="+t?e.splice(i,1):++i}}function setUpFullScreen(){isChromeApp()?document.cancelFullScreen=function(){chrome.app.window.current().restore()}:document.cancelFullScreen=document.webkitCancelFullScreen||document.mozCancelFullScreen||document.cancelFullScreen,isChromeApp()?document.body.requestFullScreen=function(){chrome.app.window.current().fullscreen()}:document.body.requestFullScreen=document.body.webkitRequestFullScreen||document.body.mozRequestFullScreen||document.body.requestFullScreen,document.onfullscreenchange=document.onfullscreenchange||document.onwebkitfullscreenchange||document.onmozfullscreenchange}function isFullScreen(){return isChromeApp()?chrome.app.window.current().isFullscreen():!!(document.webkitIsFullScreen||document.mozFullScreen||document.isFullScreen)}function fullScreenElement(){return document.webkitFullScreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement||document.fullScreenElement}function randomString(e){var t=[];e=e||5;for(var i="0123456789";e--;)t.push(i.charAt(Math.floor(Math.random()*i.length)));return t.join("")}function isChromeApp(){return"undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage&&"undefined"!=typeof chrome.storage.local}var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(e,t){if(e&&e.iceServers)for(var i=0;i<e.iceServers.length;i++)e.iceServers[i].hasOwnProperty("urls")&&(e.iceServers[i].url=e.iceServers[i].urls,delete e.iceServers[i].urls);return new mozRTCPeerConnection(e,t)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(e){setTimeout(function(){e([{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}])},0)},window.createIceServer=function(e,t,i){var n=null,o=e.split(":");if(0===o[0].indexOf("stun"))n={url:e};else if(0===o[0].indexOf("turn"))if(webrtcDetectedVersion<27){var r=e.split("?");1!==r.length&&0!==r[1].indexOf("transport=udp")||(n={url:r[0],credential:i,username:t})}else n={url:e,credential:i,username:t};return n},window.createIceServers=function(e,t,i){for(var n=[],o=0;o<e.length;o++){var r=window.createIceServer(e[o],t,i);null!==r&&n.push(r)}return n},attachMediaStream=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.mozSrcObject=t.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome";var result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);webrtcDetectedVersion=null!==result?parseInt(result[2],10):999,window.createIceServer=function(e,t,i){var n=null,o=e.split(":");return 0===o[0].indexOf("stun")?n={url:e}:0===o[0].indexOf("turn")&&(n={url:e,credential:i,username:t}),n},window.createIceServers=function(e,t,i){return{urls:e,credential:i,username:t}},RTCPeerConnection=function(e,t){return new webkitRTCPeerConnection(e,t)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(e,t){"undefined"!=typeof e.srcObject?e.srcObject=t:"undefined"!=typeof e.mozSrcObject?e.mozSrcObject=t:"undefined"!=typeof e.src?e.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},reattachMediaStream=function(e,t){e.src=t.src}}else console.log("Browser does not appear to be WebRTC-capable");var remoteVideo=$("#remote-video"),UI_CONSTANTS={confirmJoinButton:"#confirm-join-button",confirmJoinDiv:"#confirm-join-div",confirmJoinRoomSpan:"#confirm-join-room-span",fullscreenSvg:"#fullscreen",hangupSvg:"#hangup",icons:"#icons",infoDiv:"#info-div",localVideo:"#local-video",miniVideo:"#mini-video",muteAudioSvg:"#mute-audio",muteVideoSvg:"#mute-video",newRoomButton:"#new-room-button",newRoomLink:"#new-room-link",remoteVideo:"#remote-video",rejoinButton:"#rejoin-button",rejoinDiv:"#rejoin-div",rejoinLink:"#rejoin-link",roomLinkHref:"#room-link-href",roomSelectionDiv:"#room-selection",roomSelectionInput:"#room-id-input",roomSelectionInputLabel:"#room-id-input-label",roomSelectionJoinButton:"#join-button",roomSelectionRandomButton:"#random-button",roomSelectionRecentList:"#recent-rooms-list",sharingDiv:"#sharing-div",statusDiv:"#status-div",videosDiv:"#videos"},AppController=function(e){trace("Initializing; server= "+e.roomServer+"."),trace("Initializing; room="+e.roomId+"."),this.hangupSvg_=$(UI_CONSTANTS.hangupSvg),this.icons_=$(UI_CONSTANTS.icons),this.localVideo_=$(UI_CONSTANTS.localVideo),this.miniVideo_=$(UI_CONSTANTS.miniVideo),this.sharingDiv_=$(UI_CONSTANTS.sharingDiv),this.statusDiv_=$(UI_CONSTANTS.statusDiv),this.remoteVideo_=$(UI_CONSTANTS.remoteVideo),this.videosDiv_=$(UI_CONSTANTS.videosDiv),this.roomLinkHref_=$(UI_CONSTANTS.roomLinkHref),this.rejoinDiv_=$(UI_CONSTANTS.rejoinDiv),this.rejoinLink_=$(UI_CONSTANTS.rejoinLink),this.newRoomLink_=$(UI_CONSTANTS.newRoomLink),this.rejoinButton_=$(UI_CONSTANTS.rejoinButton),this.newRoomButton_=$(UI_CONSTANTS.newRoomButton),this.newRoomButton_.addEventListener("click",this.onNewRoomClick_.bind(this),!1),this.rejoinButton_.addEventListener("click",this.onRejoinClick_.bind(this),!1),this.muteAudioIconSet_=new AppController.IconSet_(UI_CONSTANTS.muteAudioSvg),this.muteVideoIconSet_=new AppController.IconSet_(UI_CONSTANTS.muteVideoSvg),this.fullscreenIconSet_=new AppController.IconSet_(UI_CONSTANTS.fullscreenSvg),this.loadingParams_=e,this.loadUrlParams_();var t=Promise.resolve({});this.loadingParams_.paramsFunction&&(t=this.loadingParams_.paramsFunction()),Promise.resolve(t).then(function(t){if(t&&Object.keys(t).forEach(function(e){this.loadingParams_[e]=t[e]}.bind(this)),this.roomLink_="",this.roomSelection_=null,this.localStream_=null,this.remoteVideoResetTimer_=null,this.loadingParams_.roomId){this.createCall_(),RoomSelection.matchRandomRoomPattern(this.loadingParams_.roomId)||($(UI_CONSTANTS.confirmJoinRoomSpan).textContent=' "'+this.loadingParams_.roomId+'"');var e=$(UI_CONSTANTS.confirmJoinDiv);this.show_(e),$(UI_CONSTANTS.confirmJoinButton).onclick=function(){this.hide_(e),(new RoomSelection.RecentlyUsedList).pushRecentRoom(this.loadingParams_.roomId),this.finishCallSetup_(this.loadingParams_.roomId)}.bind(this),this.loadingParams_.bypassJoinConfirmation&&$(UI_CONSTANTS.confirmJoinButton).onclick()}else this.showRoomSelection_()}.bind(this))["catch"](function(e){trace("Error initializing: "+e.message)}.bind(this))};AppController.prototype.createCall_=function(){this.call_=new Call(this.loadingParams_),this.infoBox_=new InfoBox($(UI_CONSTANTS.infoDiv),this.remoteVideo_,this.call_,this.loadingParams_.versionInfo);var e=this.loadingParams_.errorMessages;if(e&&0<e.length)for(var t=0;t<e.length;++t)this.infoBox_.pushErrorMessage(e[t]);else this.call_.onremotehangup=this.onRemoteHangup_.bind(this),this.call_.onremotesdpset=this.onRemoteSdpSet_.bind(this),this.call_.onremotestreamadded=this.onRemoteStreamAdded_.bind(this),this.call_.onlocalstreamadded=this.onLocalStreamAdded_.bind(this),this.call_.onsignalingstatechange=this.infoBox_.updateInfoDiv.bind(this.infoBox_),this.call_.oniceconnectionstatechange=this.infoBox_.updateInfoDiv.bind(this.infoBox_),this.call_.onnewicecandidate=this.infoBox_.recordIceCandidateTypes.bind(this.infoBox_),this.call_.onerror=this.displayError_.bind(this),this.call_.onstatusmessage=this.displayStatus_.bind(this),this.call_.oncallerstarted=this.displaySharingInfo_.bind(this)},AppController.prototype.showRoomSelection_=function(){var t=$(UI_CONSTANTS.roomSelectionDiv);this.roomSelection_=new RoomSelection(t,UI_CONSTANTS),this.show_(t),this.roomSelection_.onRoomSelected=function(e){this.hide_(t),this.createCall_(),this.finishCallSetup_(e),this.roomSelection_=null,this.localStream_&&this.attachLocalStream_()}.bind(this)},AppController.prototype.finishCallSetup_=function(e){this.call_.start(e),window.onbeforeunload=this.call_.hangup.bind(this.call_),document.onkeypress=this.onKeyPress_.bind(this),window.onmousemove=this.showIcons_.bind(this),$(UI_CONSTANTS.muteAudioSvg).onclick=this.toggleAudioMute_.bind(this),$(UI_CONSTANTS.muteVideoSvg).onclick=this.toggleVideoMute_.bind(this),$(UI_CONSTANTS.fullscreenSvg).onclick=this.toggleFullScreen_.bind(this),$(UI_CONSTANTS.hangupSvg).onclick=this.hangup_.bind(this),setUpFullScreen(),isChromeApp()||(window.onpopstate=function(e){e.state?e.state.roomLink&&(location.href=e.state.roomLink):(trace("Reloading main page."),location.href=location.origin)})},AppController.prototype.hangup_=function(){trace("Hanging up."),this.hide_(this.icons_),this.displayStatus_("Hanging up"),this.transitionToDone_(),this.call_.hangup()},AppController.prototype.onRemoteHangup_=function(){this.displayStatus_("The remote side hung up."),this.transitionToWaiting_(),this.call_.onRemoteHangup()},AppController.prototype.onRemoteSdpSet_=function(e){e?(trace("Waiting for remote video."),this.waitForRemoteVideo_()):(trace("No remote video stream; not waiting for media to arrive."),this.transitionToActive_())},AppController.prototype.waitForRemoteVideo_=function(){2<=this.remoteVideo_.readyState?(trace("Remote video started; currentTime: "+this.remoteVideo_.currentTime),this.transitionToActive_()):this.remoteVideo_.oncanplay=this.waitForRemoteVideo_.bind(this)},AppController.prototype.onRemoteStreamAdded_=function(e){this.deactivate_(this.sharingDiv_),trace("Remote stream added."),attachMediaStream(this.remoteVideo_,e),this.remoteVideoResetTimer_&&(clearTimeout(this.remoteVideoResetTimer_),this.remoteVideoResetTimer_=null)},AppController.prototype.onLocalStreamAdded_=function(e){trace("User has granted access to local media."),this.localStream_=e,this.roomSelection_||this.attachLocalStream_()},AppController.prototype.attachLocalStream_=function(){attachMediaStream(this.localVideo_,this.localStream_),this.displayStatus_(""),this.activate_(this.localVideo_),this.show_(this.icons_)},AppController.prototype.transitionToActive_=function(){this.remoteVideo_.oncanplay=undefined;var e=window.performance.now();this.infoBox_.setSetupTimes(this.call_.startTime,e),this.infoBox_.updateInfoDiv(),trace("Call setup time: "+(e-this.call_.startTime).toFixed(0)+"ms."),trace("reattachMediaStream: "+this.localVideo_.src),reattachMediaStream(this.miniVideo_,this.localVideo_),this.activate_(this.remoteVideo_),this.activate_(this.miniVideo_),this.deactivate_(this.localVideo_),this.localVideo_.src="",this.activate_(this.videosDiv_),this.show_(this.hangupSvg_),this.displayStatus_("")},AppController.prototype.transitionToWaiting_=function(){this.remoteVideo_.oncanplay=undefined,this.hide_(this.hangupSvg_),this.deactivate_(this.videosDiv_),this.remoteVideoResetTimer_||(this.remoteVideoResetTimer_=setTimeout(function(){this.remoteVideoResetTimer_=null,trace("Resetting remoteVideo src after transitioning to waiting."),this.remoteVideo_.src=""}.bind(this),800)),this.localVideo_.src=this.miniVideo_.src,this.activate_(this.localVideo_),this.deactivate_(this.remoteVideo_),this.deactivate_(this.miniVideo_)},AppController.prototype.transitionToDone_=function(){this.remoteVideo_.oncanplay=undefined,this.deactivate_(this.localVideo_),this.deactivate_(this.remoteVideo_),this.deactivate_(this.miniVideo_),this.hide_(this.hangupSvg_),this.activate_(this.rejoinDiv_),this.show_(this.rejoinDiv_),this.displayStatus_("")},AppController.prototype.onRejoinClick_=function(){this.deactivate_(this.rejoinDiv_),this.hide_(this.rejoinDiv_),this.call_.restart()},AppController.prototype.onNewRoomClick_=function(){this.deactivate_(this.rejoinDiv_),this.hide_(this.rejoinDiv_),this.showRoomSelection_()},AppController.prototype.onKeyPress_=function(e){switch(String.fromCharCode(e.charCode)){case" ":case"m":return this.call_&&this.call_.toggleAudioMute(),!1;case"c":return this.call_&&this.call_.toggleVideoMute(),!1;case"f":return this.toggleFullScreen_(),!1;case"i":return this.infoBox_.toggleInfoDiv(),!1;case"q":return this.hangup_(),!1;default:return}},AppController.prototype.pushCallNavigation_=function(e,t){isChromeApp()||window.history.pushState({roomId:e,roomLink:t},e,t)},AppController.prototype.displaySharingInfo_=function(e,t){this.roomLinkHref_.href=t,this.roomLinkHref_.text=t,this.roomLink_=t,this.pushCallNavigation_(e,t),this.activate_(this.sharingDiv_)},AppController.prototype.displayStatus_=function(e){""===e?this.deactivate_(this.statusDiv_):this.activate_(this.statusDiv_),this.statusDiv_.innerHTML=e},AppController.prototype.displayError_=function(e){trace(e),this.infoBox_.pushErrorMessage(e)},AppController.prototype.toggleAudioMute_=function(){this.call_.toggleAudioMute(),this.muteAudioIconSet_.toggle()},AppController.prototype.toggleVideoMute_=function(){this.call_.toggleVideoMute(),this.muteVideoIconSet_.toggle()},AppController.prototype.toggleFullScreen_=function(){isFullScreen()?(trace("Exiting fullscreen."),document.cancelFullScreen()):(trace("Entering fullscreen."),document.body.requestFullScreen()),this.fullscreenIconSet_.toggle()},AppController.prototype.hide_=function(e){e.classList.add("hidden")},AppController.prototype.show_=function(e){e.classList.remove("hidden")},AppController.prototype.activate_=function(e){e.classList.add("active")},AppController.prototype.deactivate_=function(e){e.classList.remove("active")},AppController.prototype.showIcons_=function(){this.icons_.classList.contains("active")||(this.activate_(this.icons_),setTimeout(function(){this.deactivate_(this.icons_)}.bind(this),5e3))},AppController.prototype.loadUrlParams_=function(){var e=queryStringToDictionary(window.location.search);this.loadingParams_.audioSendBitrate=e.asbr,this.loadingParams_.audioSendCodec=e.asc,this.loadingParams_.audioRecvBitrate=e.arbr,this.loadingParams_.audioRecvCodec=e.arc,this.loadingParams_.opusMaxPbr=e.opusmaxpbr,this.loadingParams_.opusFec=e.opusfec,this.loadingParams_.opusStereo=e.stereo,this.loadingParams_.videoSendBitrate=e.vsbr,this.loadingParams_.videoSendInitialBitrate=e.vsibr,this.loadingParams_.videoSendCodec=e.vsc,this.loadingParams_.videoRecvBitrate=e.vrbr,this.loadingParams_.videoRecvCodec=e.vrc},AppController.IconSet_=function(e){this.iconElement=document.querySelector(e)},AppController.IconSet_.prototype.toggle=function(){this.iconElement.classList.contains("on")?this.iconElement.classList.remove("on"):this.iconElement.classList.add("on")};var Call=function(e){this.params_=e,this.roomServer_=e.roomServer||"",this.channel_=new SignalingChannel(e.wssUrl,e.wssPostUrl),this.channel_.onmessage=this.onRecvSignalingChannelMessage_.bind(this),this.pcClient_=null,this.localStream_=null,this.startTime=null,this.oncallerstarted=null,this.onerror=null,this.oniceconnectionstatechange=null,this.onlocalstreamadded=null,this.onnewicecandidate=null,this.onremotehangup=null,this.onremotesdpset=null,this.onremotestreamadded=null,this.onsignalingstatechange=null,this.onstatusmessage=null,this.getMediaPromise_=null,this.getTurnServersPromise_=null,this.requestMediaAndTurnServers_()};Call.prototype.requestMediaAndTurnServers_=function(){this.getMediaPromise_=this.maybeGetMedia_(),this.getTurnServersPromise_=this.maybeGetTurnServers_()},Call.prototype.isInitiator=function(){return this.params_.isInitiator},Call.prototype.start=function(e){this.connectToRoom_(e),this.params_.isLoopback&&setupLoopback(this.params_.wssUrl,e)},Call.prototype.restart=function(){this.requestMediaAndTurnServers_(),this.start(this.params_.previousRoomId)},Call.prototype.hangup=function(){if(this.startTime=null,this.localStream_&&(this.localStream_.stop(),this.localStream_=null),this.params_.roomId){this.pcClient_&&(this.pcClient_.close(),this.pcClient_=null);var e=this.roomServer_+"/leave/"+this.params_.roomId+"/"+this.params_.clientId,t=new XMLHttpRequest;t.open("POST",e,!1),t.send(),this.channel_.send(JSON.stringify({type:"bye"})),this.channel_.close(),this.params_.previousRoomId=this.params_.roomId,this.params_.roomId=null,this.params_.clientId=null}},Call.prototype.onRemoteHangup=function(){this.startTime=null,this.params_.isInitiator=!0,this.pcClient_&&(this.pcClient_.close(),this.pcClient_=null),this.startSignaling_()},Call.prototype.getPeerConnectionStates=function(){return this.pcClient_?this.pcClient_.getPeerConnectionStates():null},Call.prototype.getPeerConnectionStats=function(e){this.pcClient_&&this.pcClient_.getPeerConnectionStats(e)},Call.prototype.toggleVideoMute=function(){var e=this.localStream_.getVideoTracks();if(0!==e.length){trace("Toggling video mute state.");for(var t=0;t<e.length;++t)e[t].enabled=!e[t].enabled;trace("Video "+(e[0].enabled?"unmuted.":"muted."))}else trace("No local video available.")},Call.prototype.toggleAudioMute=function(){var e=this.localStream_.getAudioTracks();if(0!==e.length){trace("Toggling audio mute state.");for(var t=0;t<e.length;++t)e[t].enabled=!e[t].enabled;trace("Audio "+(e[0].enabled?"unmuted.":"muted."))}else trace("No local audio available.")},Call.prototype.connectToRoom_=function(e){this.params_.roomId=e;var t=this.channel_.open()["catch"](function(e){return this.onError_("WebSocket open error: "+e.message),Promise.reject(e)}.bind(this)),i=this.joinRoom_().then(function(e){this.params_.clientId=e.client_id,this.params_.roomId=e.room_id,this.params_.roomLink=e.room_link,this.params_.isInitiator="true"===e.is_initiator,this.params_.messages=e.messages}.bind(this))["catch"](function(e){return this.onError_("Room server join error: "+e.message),Promise.reject(e)}.bind(this));Promise.all([t,i]).then(function(){this.channel_.register(this.params_.roomId,this.params_.clientId),Promise.all([this.getTurnServersPromise_,this.getMediaPromise_]).then(function(){this.startSignaling_()}.bind(this))["catch"](function(e){this.onError_("Failed to start signaling: "+e.message)}.bind(this))}.bind(this))["catch"](function(e){this.onError_("WebSocket register error: "+e.message)}.bind(this))},Call.prototype.maybeGetMedia_=function(){var e=null;if(!1!==this.params_.mediaConstraints.audio||!1!==this.params_.mediaConstraints.video){var t=this.params_.mediaConstraints;e=requestUserMedia(t).then(function(e){trace("Got access to local media with mediaConstraints:\n  '"+JSON.stringify(t)+"'"),this.onUserMediaSuccess_(e)}.bind(this))["catch"](function(e){this.onError_("Error getting user media: "+e.message),this.onUserMediaError_(e)}.bind(this))}else e=Promise.resolve();return e},Call.prototype.maybeGetTurnServers_=function(){var e=null;this.params_.turnRequestUrl&&0<this.params_.turnRequestUrl.length?e=requestTurnServers(this.params_.turnRequestUrl,this.params_.turnTransports).then(function(e){var t=this.params_.peerConnectionConfig.iceServers;this.params_.peerConnectionConfig.iceServers=t.concat(e)}.bind(this))["catch"](function(e){if(this.onstatusmessage){var t=encodeURIComponent("AppRTC demo TURN server not working");this.onstatusmessage('No TURN server; unlikely that media will traverse networks. If this persists please <a href="mailto:discuss-webrtc@googlegroups.com?subject='+t+'">report it to discuss-webrtc@googlegroups.com</a>.')}trace(e.message)}.bind(this)):e=Promise.resolve();return e},Call.prototype.onUserMediaSuccess_=function(e){this.localStream_=e,this.onlocalstreamadded&&this.onlocalstreamadded(e)},Call.prototype.onUserMediaError_=function(e){var t="Failed to get access to local media. Error name was "+e.name+". Continuing without sending a stream.";this.onError_("getUserMedia error: "+t),alert(t)},Call.prototype.maybeCreatePcClient_=function(){if(!this.pcClient_)try{this.pcClient_=new PeerConnectionClient(this.params_,this.startTime),this.pcClient_.onsignalingmessage=this.sendSignalingMessage_.bind(this),this.pcClient_.onremotehangup=this.onremotehangup,this.pcClient_.onremotesdpset=this.onremotesdpset,this.pcClient_.onremotestreamadded=this.onremotestreamadded,this.pcClient_.onsignalingstatechange=this.onsignalingstatechange,this.pcClient_.oniceconnectionstatechange=this.oniceconnectionstatechange,this.pcClient_.onnewicecandidate=this.onnewicecandidate,this.pcClient_.onerror=this.onerror,trace("Created PeerConnectionClient")}catch(e){return this.onError_("Create PeerConnection exception: "+e.message),void alert("Cannot create RTCPeerConnection; WebRTC is not supported by this browser.")}},Call.prototype.startSignaling_=function(){trace("Starting signaling."),this.isInitiator()&&this.oncallerstarted&&this.oncallerstarted(this.params_.roomId,this.params_.roomLink),this.startTime=window.performance.now(),this.maybeCreatePcClient_(),this.localStream_&&(trace("Adding local stream."),this.pcClient_.addStream(this.localStream_)),this.params_.isInitiator?this.pcClient_.startAsCaller(this.params_.offerConstraints):this.pcClient_.startAsCallee(this.params_.messages)},Call.prototype.joinRoom_=function(){return new Promise(function(i,n){this.params_.roomId||n(Error("Missing room id.")),sendAsyncUrlRequest("POST",this.roomServer_+"/join/"+this.params_.roomId+window.location.search).then(function(e){var t=parseJSON(e);t?"SUCCESS"===t.result?(trace("Joined the room."),i(t.params)):n(Error("Registration error: "+t.result)):n(Error("Error parsing response JSON."))}.bind(this))["catch"](function(e){n(Error("Failed to join the room: "+e.message))}.bind(this))}.bind(this))},Call.prototype.onRecvSignalingChannelMessage_=function(e){this.maybeCreatePcClient_(),this.pcClient_.receiveSignalingMessage(e)},Call.prototype.sendSignalingMessage_=function(e){var t=JSON.stringify(e);if(this.params_.isInitiator){var i=this.roomServer_+"/message/"+this.params_.roomId+"/"+this.params_.clientId+window.location.search,n=new XMLHttpRequest;n.open("POST",i,!0),n.send(t),trace("C->GAE: "+t)}else this.channel_.send(t)},Call.prototype.onError_=function(e){this.onerror&&this.onerror(e)};var InfoBox=function(e,t,i,n){this.infoDiv_=e,this.remoteVideo_=t,this.call_=i,this.versionInfo_=n,this.errorMessages_=[],this.startTime_=null,this.connectTime_=null,this.stats_=null,this.prevStats_=null,this.getStatsTimer_=null,this.iceCandidateTypes_={Local:{},Remote:{}}};InfoBox.prototype.recordIceCandidateTypes=function(e,t){var i=iceCandidateType(t),n=this.iceCandidateTypes_[e];n[i]?++n[i]:n[i]=1,this.updateInfoDiv()},InfoBox.prototype.pushErrorMessage=function(e){this.errorMessages_.push(e),this.updateInfoDiv(),this.showInfoDiv()},InfoBox.prototype.setSetupTimes=function(e,t){this.startTime_=e,this.connectTime_=t},InfoBox.prototype.showInfoDiv=function(){this.getStatsTimer_=setInterval(this.refreshStats_.bind(this),1e3),this.refreshStats_(),this.infoDiv_.classList.add("active")},InfoBox.prototype.toggleInfoDiv=function(){this.infoDiv_.classList.contains("active")?(clearInterval(this.getStatsTimer_),this.infoDiv_.classList.remove("active")):this.showInfoDiv()},InfoBox.prototype.refreshStats_=function(){this.call_.getPeerConnectionStats(function(e){this.prevStats_=this.stats_,this.stats_=e.result(),this.updateInfoDiv()}.bind(this))},InfoBox.prototype.updateInfoDiv=function(){var e='<pre id="info-box-stats" style="line-height: initial">';if(this.stats_){var t=this.call_.getPeerConnectionStates();if(!t)return;for(var i in e+=this.buildLine_("States"),e+=this.buildLine_("Signaling",t.signalingState),e+=this.buildLine_("Gathering",t.iceGatheringState),e+=this.buildLine_("Connection",t.iceConnectionState),this.iceCandidateTypes_){var n=[];for(var o in this.iceCandidateTypes_[i])n.push(o+":"+this.iceCandidateTypes_[i][o]);e+=this.buildLine_(i,n.join(" "))}var r,s,a,c,l=getStatsReport(this.stats_,"googCandidatePair","googActiveConnection","true");l&&(r=l.stat("googLocalAddress"),s=l.stat("googRemoteAddress"),a=l.stat("googLocalCandidateType"),c=l.stat("googRemoteCandidateType")),r&&s&&(e+=this.buildLine_("LocalAddr",r+" ("+a+")"),e+=this.buildLine_("RemoteAddr",s+" ("+c+")")),e+=this.buildLine_(),e+=this.buildStatsSection_()}if(this.errorMessages_.length){this.infoDiv_.classList.add("warning");for(var d=0;d!==this.errorMessages_.length;++d)e+=this.errorMessages_[d]+"\n"}else this.infoDiv_.classList.remove("warning");if(this.versionInfo_)for(var h in e+=this.buildLine_(),e+=this.buildLine_("Version"),this.versionInfo_)e+=this.buildLine_(h,this.versionInfo_[h]);e+="</pre>",this.infoDiv_.innerHTML!==e&&(this.infoDiv_.innerHTML=e)},InfoBox.prototype.buildStatsSection_=function(){var e=this.buildLine_("Stats"),t=extractStatAsInt(this.stats_,"ssrc","googRtt"),i=computeE2EDelay(extractStatAsInt(this.stats_,"ssrc","googCaptureStartNtpTimeMs"),this.remoteVideo_.currentTime);null!==this.endTime_&&(e+=this.buildLine_("Call time",InfoBox.formatInterval_(window.performance.now()-this.connectTime_)),e+=this.buildLine_("Setup time",InfoBox.formatMsec_(this.connectTime_-this.startTime_))),null!==t&&(e+=this.buildLine_("RTT",InfoBox.formatMsec_(t))),null!==i&&(e+=this.buildLine_("End to end",InfoBox.formatMsec_(i)));var n,o,r,s,a,c,l,d,h,u,p,m,_,g,f,S,v=getStatsReport(this.stats_,"ssrc","audioInputLevel"),C=getStatsReport(this.stats_,"ssrc","audioOutputLevel"),R=getStatsReport(this.stats_,"ssrc","googFirsReceived"),b=getStatsReport(this.stats_,"ssrc","googFirsSent"),y=getStatsReport(this.prevStats_,"ssrc","audioInputLevel"),I=getStatsReport(this.prevStats_,"ssrc","audioOutputLevel"),w=getStatsReport(this.prevStats_,"ssrc","googFirsReceived"),T=getStatsReport(this.prevStats_,"ssrc","googFirsSent");return v&&(n=v.stat("googCodecName"),o=computeBitrate(v,y,"bytesSent"),r=computeRate(v,y,"packetsSent"),e+=this.buildLine_("Audio Tx",n+", "+InfoBox.formatBitrate_(o)+", "+InfoBox.formatPacketRate_(r))),C&&(s=C.stat("googCodecName"),a=computeBitrate(C,I,"bytesReceived"),c=computeRate(C,I,
"packetsReceived"),e+=this.buildLine_("Audio Rx",s+", "+InfoBox.formatBitrate_(a)+", "+InfoBox.formatPacketRate_(c))),R&&(h=R.stat("googCodecName"),l=R.stat("googFrameHeightSent"),d=R.stat("googFrameRateSent"),u=computeBitrate(R,w,"bytesSent"),p=computeRate(R,w,"packetsSent"),e+=this.buildLine_("Video Tx",h+", "+l.toString()+"p"+d.toString()+", "+InfoBox.formatBitrate_(u)+", "+InfoBox.formatPacketRate_(p))),b&&(g="TODO",m=this.remoteVideo_.videoHeight,_=b.stat("googFrameRateDecoded"),f=computeBitrate(b,T,"bytesReceived"),S=computeRate(b,T,"packetsReceived"),e+=this.buildLine_("Video Rx",g+", "+m.toString()+"p"+_.toString()+", "+InfoBox.formatBitrate_(f)+", "+InfoBox.formatPacketRate_(S))),e},InfoBox.prototype.buildLine_=function(e,t){var i=12,n="";if(e){for(n+=e+":";n.length<i;)n+=" ";t&&(n+=t)}return n+="\n"},InfoBox.formatInterval_=function(e){var t="",i=Math.floor(e/1e3),n=Math.floor(i/60),o=Math.floor(n/60),r=function(e){return(e<10?"0":"")+e.toString()};return 0<o&&(t+=r(o)+":"),t+=r(n-60*o)+":",t+=r(i-60*n)},InfoBox.formatMsec_=function(e){return e.toFixed(0).toString()+" ms"},InfoBox.formatBitrate_=function(e){return e?(e<1e3?t="bps":e<1e6?(t="kbps",e/=1e3):(t="Mbps",e/=1e6),e.toPrecision(3)+" "+t):"- bps";var t},InfoBox.formatPacketRate_=function(e){return e?e.toPrecision(3)+" pps":"- pps"};var PeerConnectionClient=function(e,t){this.params_=e,this.startTime_=t,trace("Creating RTCPeerConnnection with:\n  config: '"+JSON.stringify(e.peerConnectionConfig)+"';\n  constraints: '"+JSON.stringify(e.peerConnectionConstraints)+"'."),this.pc_=new RTCPeerConnection(e.peerConnectionConfig,e.peerConnectionConstraints),this.pc_.onicecandidate=this.onIceCandidate_.bind(this),this.pc_.onaddstream=this.onRemoteStreamAdded_.bind(this),this.pc_.onremovestream=trace.bind(null,"Remote stream removed."),this.pc_.onsignalingstatechange=this.onSignalingStateChanged_.bind(this),this.pc_.oniceconnectionstatechange=this.onIceConnectionStateChanged_.bind(this),this.hasRemoteSdp_=!1,this.messageQueue_=[],this.isInitiator_=!1,this.started_=!1,this.onerror=null,this.oniceconnectionstatechange=null,this.onnewicecandidate=null,this.onremotehangup=null,this.onremotesdpset=null,this.onremotestreamadded=null,this.onsignalingmessage=null,this.onsignalingstatechange=null};PeerConnectionClient.DEFAULT_SDP_CONSTRAINTS_={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{VoiceActivityDetection:!1}]},PeerConnectionClient.prototype.addStream=function(e){this.pc_&&this.pc_.addStream(e)},PeerConnectionClient.prototype.startAsCaller=function(e){if(!this.pc_)return!1;if(this.started_)return!1;this.isInitiator_=!0,this.started_=!0;var t=mergeConstraints(e,PeerConnectionClient.DEFAULT_SDP_CONSTRAINTS_);return trace("Sending offer to peer, with constraints: \n'"+JSON.stringify(t)+"'."),this.pc_.createOffer(this.setLocalSdpAndNotify_.bind(this),this.onError_.bind(this,"createOffer"),t),!0},PeerConnectionClient.prototype.startAsCallee=function(e){if(!this.pc_)return!1;if(this.started_)return!1;if(this.isInitiator_=!1,this.started_=!0,e&&0<e.length){for(var t=0,i=e.length;t<i;t++)this.receiveSignalingMessage(e[t]);return!0}return 0<this.messageQueue_.length&&this.drainMessageQueue_(),!0},PeerConnectionClient.prototype.receiveSignalingMessage=function(e){var t=parseJSON(e);t&&(this.isInitiator_&&"answer"===t.type||!this.isInitiator_&&"offer"===t.type?(this.hasRemoteSdp_=!0,this.messageQueue_.unshift(t)):"candidate"===t.type?this.messageQueue_.push(t):"bye"===t.type&&this.onremotehangup&&this.onremotehangup(),this.drainMessageQueue_())},PeerConnectionClient.prototype.close=function(){this.pc_&&(this.pc_.close(),this.pc_=null)},PeerConnectionClient.prototype.getPeerConnectionStates=function(){return this.pc_?{signalingState:this.pc_.signalingState,iceGatheringState:this.pc_.iceGatheringState,iceConnectionState:this.pc_.iceConnectionState}:null},PeerConnectionClient.prototype.getPeerConnectionStats=function(e){this.pc_&&this.pc_.getStats(e)},PeerConnectionClient.prototype.doAnswer_=function(){trace("Sending answer to peer."),this.pc_.createAnswer(this.setLocalSdpAndNotify_.bind(this),this.onError_.bind(this,"createAnswer"),PeerConnectionClient.DEFAULT_SDP_CONSTRAINTS_)},PeerConnectionClient.prototype.setLocalSdpAndNotify_=function(e){e.sdp=maybePreferAudioReceiveCodec(e.sdp,this.params_),e.sdp=maybePreferVideoReceiveCodec(e.sdp,this.params_),e.sdp=maybeSetAudioReceiveBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoReceiveBitRate(e.sdp,this.params_),this.pc_.setLocalDescription(e,trace.bind(null,"Set session description success."),this.onError_.bind(this,"setLocalDescription")),this.onsignalingmessage&&this.onsignalingmessage(e)},PeerConnectionClient.prototype.setRemoteSdp_=function(e){e.sdp=maybeSetOpusOptions(e.sdp,this.params_),e.sdp=maybePreferAudioSendCodec(e.sdp,this.params_),e.sdp=maybePreferVideoSendCodec(e.sdp,this.params_),e.sdp=maybeSetAudioSendBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoSendBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoSendInitialBitRate(e.sdp,this.params_),this.pc_.setRemoteDescription(new RTCSessionDescription(e),this.onSetRemoteDescriptionSuccess_.bind(this),this.onError_.bind(this,"setRemoteDescription"))},PeerConnectionClient.prototype.onSetRemoteDescriptionSuccess_=function(){trace("Set remote session description success.");var e=this.pc_.getRemoteStreams();this.onremotesdpset&&this.onremotesdpset(0<e.length&&0<e[0].getVideoTracks().length)},PeerConnectionClient.prototype.processSignalingMessage_=function(e){if("offer"!==e.type||this.isInitiator_)if("answer"===e.type&&this.isInitiator_){if("have-local-offer"!==this.pc_.signalingState)return void trace("ERROR: remote answer received in unexpected state: "+this.pc_.signalingState);this.setRemoteSdp_(e)}else if("candidate"===e.type){var t=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.recordIceCandidate_("Remote",t),this.pc_.addIceCandidate(t,trace.bind(null,"Remote candidate added successfully."),this.onError_.bind(this,"addIceCandidate"))}else trace("WARNING: unexpected message: "+JSON.stringify(e));else{if("stable"!==this.pc_.signalingState)return void trace("ERROR: remote offer received in unexpected state: "+this.pc_.signalingState);this.setRemoteSdp_(e),this.doAnswer_()}},PeerConnectionClient.prototype.drainMessageQueue_=function(){if(this.pc_&&this.started_&&this.hasRemoteSdp_){for(var e=0,t=this.messageQueue_.length;e<t;e++)this.processSignalingMessage_(this.messageQueue_[e]);this.messageQueue_=[]}},PeerConnectionClient.prototype.onIceCandidate_=function(e){if(e.candidate){if(this.filterIceCandidate_(e.candidate)){var t={type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate};this.onsignalingmessage&&this.onsignalingmessage(t),this.recordIceCandidate_("Local",e.candidate)}}else trace("End of candidates.")},PeerConnectionClient.prototype.onSignalingStateChanged_=function(){this.pc_&&(trace("Signaling state changed to: "+this.pc_.signalingState),this.onsignalingstatechange&&this.onsignalingstatechange())},PeerConnectionClient.prototype.onIceConnectionStateChanged_=function(){this.pc_&&(trace("ICE connection state changed to: "+this.pc_.iceConnectionState),"completed"===this.pc_.iceConnectionState&&trace("ICE complete time: "+(window.performance.now()-this.startTime_).toFixed(0)+"ms."),this.oniceconnectionstatechange&&this.oniceconnectionstatechange())},PeerConnectionClient.prototype.filterIceCandidate_=function(e){var t=e.candidate;return-1===t.indexOf("tcp")&&("relay"!==this.params_.peerConnectionConfig.iceTransports||"relay"===iceCandidateType(t))},PeerConnectionClient.prototype.recordIceCandidate_=function(e,t){this.onnewicecandidate&&this.onnewicecandidate(e,t.candidate)},PeerConnectionClient.prototype.onRemoteStreamAdded_=function(e){this.onremotestreamadded&&this.onremotestreamadded(e.stream)},PeerConnectionClient.prototype.onError_=function(e,t){this.onerror&&this.onerror(e+": "+t.toString())};var RoomSelection=function(e,t,i,n){this.roomSelectionDiv_=e,this.setupCompletedCallback_=n,this.roomIdInput_=this.roomSelectionDiv_.querySelector(t.roomSelectionInput),this.roomIdInputLabel_=this.roomSelectionDiv_.querySelector(t.roomSelectionInputLabel),this.roomJoinButton_=this.roomSelectionDiv_.querySelector(t.roomSelectionJoinButton),this.roomRandomButton_=this.roomSelectionDiv_.querySelector(t.roomSelectionRandomButton),this.roomRecentList_=this.roomSelectionDiv_.querySelector(t.roomSelectionRecentList),this.roomIdInput_.value=randomString(9),this.onRoomIdInput_(),this.roomIdInput_.addEventListener("input",this.onRoomIdInput_.bind(this),!1),this.roomIdInput_.addEventListener("keyup",this.onRoomIdKeyPress_.bind(this),!1),this.roomRandomButton_.addEventListener("click",this.onRandomButton_.bind(this),!1),this.roomJoinButton_.addEventListener("click",this.onJoinButton_.bind(this),!1),this.onRoomSelected=null,this.recentlyUsedList_=new RoomSelection.RecentlyUsedList(i),this.startBuildingRecentRoomList_()};RoomSelection.matchRandomRoomPattern=function(e){return null!==e.match(/^\d{9}$/)},RoomSelection.prototype.startBuildingRecentRoomList_=function(){this.recentlyUsedList_.getRecentRooms().then(function(e){this.buildRecentRoomList_(e),this.setupCompletedCallback_&&this.setupCompletedCallback_()}.bind(this))["catch"](function(e){trace("Error building recent rooms list: "+e.message)}.bind(this))},RoomSelection.prototype.buildRecentRoomList_=function(e){for(var t=this.roomRecentList_.lastChild;t;)this.roomRecentList_.removeChild(t),t=this.roomRecentList_.lastChild;for(var i=0;i<e.length;++i){var n=document.createElement("li"),o=document.createElement("a"),r=document.createTextNode(e[i]);o.appendChild(r),o.href=location.origin+"/r/"+encodeURIComponent(e[i]),n.appendChild(o),this.roomRecentList_.appendChild(n),o.addEventListener("click",this.makeRecentlyUsedClickHandler_(e[i]).bind(this),!1)}},RoomSelection.prototype.onRoomIdInput_=function(){var e=this.roomIdInput_.value,t=5<=e.length;(t=t&&/^\w+$/.exec(e))?(this.roomJoinButton_.disabled=!1,this.roomIdInput_.classList.remove("invalid"),this.roomIdInputLabel_.classList.add("hidden")):(this.roomJoinButton_.disabled=!0,this.roomIdInput_.classList.add("invalid"),this.roomIdInputLabel_.classList.remove("hidden"))},RoomSelection.prototype.onRoomIdKeyPress_=function(e){13!==e.which||this.roomJoinButton_.disabled||this.onJoinButton_()},RoomSelection.prototype.onRandomButton_=function(){this.roomIdInput_.value=randomString(9),this.onRoomIdInput_()},RoomSelection.prototype.onJoinButton_=function(){this.loadRoom_(this.roomIdInput_.value)},RoomSelection.prototype.makeRecentlyUsedClickHandler_=function(t){return function(e){e.preventDefault(),this.loadRoom_(t)}},RoomSelection.prototype.loadRoom_=function(e){this.recentlyUsedList_.pushRecentRoom(e),this.onRoomSelected&&this.onRoomSelected(e)},RoomSelection.RecentlyUsedList=function(e){this.LISTLENGTH_=10,this.RECENTROOMSKEY_=e||"recentRooms",this.storage_=new Storage},RoomSelection.RecentlyUsedList.prototype.pushRecentRoom=function(n){return new Promise(function(t,i){n?this.getRecentRooms().then(function(e){e=(e=(e=[n].concat(e)).filter(function(e,t,i){return i.indexOf(e)===t})).slice(0,this.LISTLENGTH_),this.storage_.setStorage(this.RECENTROOMSKEY_,JSON.stringify(e),function(){t()})}.bind(this))["catch"](function(e){i(e)}.bind(this)):t()}.bind(this))},RoomSelection.RecentlyUsedList.prototype.getRecentRooms=function(){return new Promise(function(i){this.storage_.getStorage(this.RECENTROOMSKEY_,function(e){var t=parseJSON(e);t||(t=[]),i(t)})}.bind(this))};var SignalingChannel=function(e,t){this.wssUrl_=e,this.wssPostUrl_=t,this.roomId_=null,this.clientId_=null,this.websocket_=null,this.registered_=!1,this.onerror=null,this.onmessage=null};SignalingChannel.prototype.open=function(){if(!this.websocket_)return trace("Opening signaling channel."),new Promise(function(e,t){this.websocket_=new WebSocket(this.wssUrl_),this.websocket_.onopen=function(){trace("Signaling channel opened."),this.websocket_.onerror=function(){trace("Signaling channel error.")},this.websocket_.onclose=function(e){trace("Channel closed with code:"+e.code+" reason:"+e.reason),this.websocket_=null,this.registered_=!1},this.clientId_&&this.roomId_&&this.register(this.roomId_,this.clientId_),e()}.bind(this),this.websocket_.onmessage=function(e){trace("WSS->C: "+e.data);var t=parseJSON(e.data);t?t.error?trace("Signaling server error message: "+t.error):this.onmessage(t.msg):trace("Failed to parse WSS message: "+e.data)}.bind(this),this.websocket_.onerror=function(){t(Error("WebSocket error."))}}.bind(this));trace("ERROR: SignalingChannel has already opened.")},SignalingChannel.prototype.register=function(e,t){if(this.registered_)trace("ERROR: SignalingChannel has already registered.");else if(this.roomId_=e,this.clientId_=t,this.roomId_||trace("ERROR: missing roomId."),this.clientId_||trace("ERROR: missing clientId."),this.websocket_&&this.websocket_.readyState===WebSocket.OPEN){trace("Registering signaling channel.");var i={cmd:"register",roomid:this.roomId_,clientid:this.clientId_};this.websocket_.send(JSON.stringify(i)),this.registered_=!0,trace("Signaling channel registered.")}else trace("WebSocket not open yet; saving the IDs to register later.")},SignalingChannel.prototype.close=function(){if(this.websocket_&&(this.websocket_.close(),this.websocket_=null),this.clientId_&&this.roomId_){var e=this.wssPostUrl_+"/"+this.roomId_+"/"+this.clientId_,t=new XMLHttpRequest;t.open("DELETE",e,!1),t.send(),this.clientId_=null,this.roomId_=null,this.registered_=!1}},SignalingChannel.prototype.send=function(e){if(this.roomId_&&this.clientId_){trace("C->WSS: "+e);var t={cmd:"send",msg:e},i=JSON.stringify(t);if(this.websocket_&&this.websocket_.readyState===WebSocket.OPEN)this.websocket_.send(i);else{var n=this.wssPostUrl_+"/"+this.roomId_+"/"+this.clientId_,o=new XMLHttpRequest;o.open("POST",n,!0),o.send(t.msg)}}else trace("ERROR: SignalingChannel has not registered.")};var Storage=function(){};Storage.prototype.getStorage=function(t,i){if(isChromeApp())chrome.storage.local.get(t,function(e){i&&window.setTimeout(function(){i(e[t])},0)});else{var e=localStorage.getItem(t);i&&window.setTimeout(function(){i(e)},0)}},Storage.prototype.setStorage=function(e,t,i){if(isChromeApp()){var n={};n[e]=t,chrome.storage.local.set(n,i)}else localStorage.setItem(e,t),i&&window.setTimeout(i,0)};